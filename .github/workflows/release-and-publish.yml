name: Release & Publish (Automated)

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/chores-*.yml'
      - '.github/workflows/deploy-docs.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-please-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
      pr: ${{ steps.release.outputs.pr }}

    steps:
      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        with:
          token: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
          config-file: .github/release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      - name: Summary - Release Created
        if: steps.release.outputs.release_created == 'true'
        run: |
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.release.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: ${{ steps.release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Upload URL**: ${{ steps.release.outputs.upload_url }}" >> $GITHUB_STEP_SUMMARY

      - name: Summary - Release PR
        if: steps.release.outputs.pr != ''
        run: |
          echo "## ðŸ“ Release PR Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release Please has updated the release PR" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number**: ${{ steps.release.outputs.prs_created }}" >> $GITHUB_STEP_SUMMARY

      - name: Summary - No Changes
        if: steps.release.outputs.release_created != 'true' && steps.release.outputs.pr == ''
        run: |
          echo "## â„¹ï¸ No Release Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No conventional commits found that require a release." >> $GITHUB_STEP_SUMMARY

  publish:
    name: Publish to NPM
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    uses: ./.github/workflows/reusable/reusable-npm-publish.yml
    with:
      version: ${{ needs.release-please.outputs.version }}
      npm-scope: 'pantheon-org'
      project-name: 'opencode-warcraft-notifications-plugin'
    secrets:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-docs:
    name: Deploy Documentation
    needs: [release-please, publish]
    if: needs.release-please.outputs.release_created == 'true' && success()
    uses: ./.github/workflows/reusable/reusable-deploy-docs.yml
    with:
      commit-sha: ${{ github.sha }}
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
